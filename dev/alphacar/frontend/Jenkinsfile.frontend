pipeline {
    agent any

    environment {
        // Harbor
        HARBOR_URL     = 'http://192.168.56.200:30002'
        HARBOR_PROJECT = 'alphacar'
        IMAGE_NAME     = 'frontend'
        HARBOR_CRED_ID = 'harbor-cred'

        // SonarQube
        SONARQUBE = 'sonarqube'
        SONAR_HOST_URL = 'http://192.168.56.200:32001'
        SONAR_TOKEN_ID = 'sonarqube-token'
    }

    stages {

        stage('Prepare') {
            steps {
                script {
                    def baseVer = "1.0"
                    try {
                        baseVer = readFile('frontend/version.txt').trim()
                    } catch (e) {
                        echo "âš ï¸ version.txt ì—†ìŒ â†’ 1.0 ì‚¬ìš©"
                    }
                    env.FULL_VERSION = "${baseVer}.${currentBuild.number}"
                    echo "ğŸ“¦ Build Version: ${env.FULL_VERSION}"
                }
            }
        }

        stage('SonarQube Analysis') {
            steps {
                script {
                    // SonarQube ì—°ê²° í™•ì¸ ë° ì„ íƒì  ì‹¤í–‰
                    def sonarAvailable = false
                    try {
                        def response = sh(
                            script: "curl -s -m 5 ${SONAR_HOST_URL}/api/system/status || echo 'FAILED'",
                            returnStdout: true
                        ).trim()
                        if (response.contains('"status"') || response.contains('UP')) {
                            sonarAvailable = true
                            echo "âœ… SonarQube ì„œë²„ ì—°ê²° í™•ì¸ë¨"
                        }
                    } catch (Exception e) {
                        echo "âš ï¸ SonarQube ì„œë²„ ì—°ê²° ì‹¤íŒ¨: ${e.getMessage()}"
                    }
                    
                    if (sonarAvailable) {
                        def scannerHome = tool 'sonar-scanner'
                        
                        // SonarQube ì¸ì¦ í† í° ì‚¬ìš© (Node.js ì˜¤ë¥˜ ë¬´ì‹œ, ANALYSIS SUCCESSFUL í™•ì¸)
                        try {
                            withSonarQubeEnv("${SONARQUBE}") {
                                def output = sh(
                                    script: """
                                        ${scannerHome}/bin/sonar-scanner \\
                                            -Dsonar.projectKey=alphacar-frontend \\
                                            -Dsonar.projectName=alphacar-frontend \\
                                            -Dsonar.sources=frontend \\
                                            -Dsonar.host.url=${SONAR_HOST_URL} \\
                                            -Dsonar.sourceEncoding=UTF-8 \\
                                            -Dsonar.exclusions=**/node_modules/**,**/.next/**,**/dist/**,**/out/**,**/*.html \\
                                            -Dsonar.scanner.timeout=300 2>&1
                                    """,
                                    returnStdout: true
                                )
                                if (output.contains("ANALYSIS SUCCESSFUL")) {
                                    echo "âœ… SonarQube ë¶„ì„ ì™„ë£Œ (Node.js ê²½ê³ ëŠ” ë¬´ì‹œë¨)"
                                } else {
                                    echo "âš ï¸ SonarQube ë¶„ì„ ì™„ë£Œ (ì¼ë¶€ ê²½ê³  ë°œìƒ, ê³„ì† ì§„í–‰)"
                                }
                            }
                        } catch (Exception e) {
                            // withSonarQubeEnv ì‹¤íŒ¨ ì‹œ í† í° ì§ì ‘ ì‚¬ìš© ì‹œë„
                            echo "âš ï¸ withSonarQubeEnv ì‹¤íŒ¨, í† í° ì§ì ‘ ì‚¬ìš© ì‹œë„..."
                            try {
                                withCredentials([string(credentialsId: "${SONAR_TOKEN_ID}", variable: 'SONAR_TOKEN')]) {
                                    def output = sh(
                                        script: """
                                            ${scannerHome}/bin/sonar-scanner \\
                                                -Dsonar.projectKey=alphacar-frontend \\
                                                -Dsonar.projectName=alphacar-frontend \\
                                                -Dsonar.sources=frontend \\
                                                -Dsonar.host.url=${SONAR_HOST_URL} \\
                                                -Dsonar.token=\${SONAR_TOKEN} \\
                                                -Dsonar.sourceEncoding=UTF-8 \\
                                                -Dsonar.exclusions=**/node_modules/**,**/.next/**,**/dist/**,**/out/**,**/*.html \\
                                                -Dsonar.scanner.timeout=300 2>&1
                                        """,
                                        returnStdout: true
                                    )
                                    if (output.contains("ANALYSIS SUCCESSFUL")) {
                                        echo "âœ… SonarQube ë¶„ì„ ì™„ë£Œ (í† í° ì‚¬ìš©, Node.js ê²½ê³ ëŠ” ë¬´ì‹œë¨)"
                                    } else {
                                        echo "âš ï¸ SonarQube ë¶„ì„ ì™„ë£Œ (ì¼ë¶€ ê²½ê³  ë°œìƒ, ê³„ì† ì§„í–‰)"
                                    }
                                }
                            } catch (Exception e2) {
                                echo "âš ï¸ SonarQube ë¶„ì„ ì‹¤íŒ¨, ê³„ì† ì§„í–‰: ${e2.getMessage()}"
                            }
                        }
                    } else {
                        echo "âš ï¸ SonarQube ì„œë²„ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë¶„ì„ì„ ê±´ë„ˆëœë‹ˆë‹¤."
                    }
                    echo "âœ… SonarQube ë‹¨ê³„ ì™„ë£Œ - Trivyë¡œ ì§„í–‰"
                }
            }
        }

        stage('Trivy Security Scan') {
            steps {
                script {
                    // Trivy DB ì—…ë°ì´íŠ¸
                    echo "ğŸ”„ Updating Trivy DB..."
                    sh "docker run --rm -v trivy_cache:/root/.cache aquasec/trivy:latest image --download-db-only || true"
                    
                    def TRIVY_OPTIONS = "--exit-code 0 --severity HIGH,CRITICAL --timeout 5m --no-progress --skip-db-update --skip-files 'root/.npm/_cacache/*' --cache-dir /root/.cache/trivy"
                    
                    echo "ğŸ›¡ï¸ Scanning Frontend source code..."
                    sh """
                        docker run --rm \\
                            -v \$(pwd):/workspace \\
                            -v trivy_cache:/root/.cache \\
                            -w /workspace \\
                            aquasec/trivy:latest fs ${TRIVY_OPTIONS} \\
                            frontend/ 2>&1 || true
                    """
                    echo "âœ… Trivy ë³´ì•ˆ ìŠ¤ìº” ì™„ë£Œ - ë¹Œë“œë¡œ ì§„í–‰"
                }
            }
        }

        stage('Docker Build & Push') {
            steps {
                script {
                    def imageTag = "192.168.56.200:30002/${HARBOR_PROJECT}/${IMAGE_NAME}:${env.FULL_VERSION}"
                    def imageTagLatest = "192.168.56.200:30002/${HARBOR_PROJECT}/${IMAGE_NAME}:latest"

                    echo "ğŸ³ Docker Build: ${imageTag}"
                    
                    def imageTagNoHttp = "192.168.56.200:30002/${HARBOR_PROJECT}/${IMAGE_NAME}:${env.FULL_VERSION}"
                    def imageTagLatestNoHttp = "192.168.56.200:30002/${HARBOR_PROJECT}/${IMAGE_NAME}:latest"
                    
                    // BuildKit í™œì„±í™” ë° ìºì‹œ ì´ë¯¸ì§€ pull
                    sh """
                        export DOCKER_BUILDKIT=1
                        docker pull ${imageTagLatestNoHttp} || true
                        
                        # BuildKitì„ ì‚¬ìš©í•œ ë¹ ë¥¸ ë¹Œë“œ (ì¼ë°˜ docker build ì‚¬ìš© - ë” ì•ˆì •ì )
                        docker build \\
                            --cache-from ${imageTagLatestNoHttp} \\
                            --progress=plain \\
                            -f frontend/Dockerfile \\
                            -t ${imageTagNoHttp} \\
                            -t ${imageTagLatestNoHttp} \\
                            frontend/
                    """
                    
                    // ë³€ìˆ˜ ì—…ë°ì´íŠ¸
                    imageTag = imageTagNoHttp
                    imageTagLatest = imageTagLatestNoHttp

                    withCredentials([usernamePassword(
                        credentialsId: HARBOR_CRED_ID,
                        usernameVariable: 'HARBOR_USER',
                        passwordVariable: 'HARBOR_PASS'
                    )]) {
                        sh """
                            # Harbor ë¡œê·¸ì¸ (í”„ë¡œí† ì½œ ì—†ì´ ì‹œë„ - Docker daemonì´ insecure registryë¡œ ì¸ì‹)
                            echo "\${HARBOR_PASS}" | docker login 192.168.56.200:30002 -u \${HARBOR_USER} --password-stdin
                            docker push ${imageTag}
                            docker push ${imageTagLatest}
                            docker logout 192.168.56.200:30002
                        """
                    }

                    sh "docker rmi ${imageTag} || true"
                    echo "âœ… Frontend image pushed to Harbor"
                }
            }
        }
    }

    post {
        success {
            echo "âœ… SonarQube í†µê³¼ + Harbor Push ì„±ê³µ"
        }
        failure {
            echo "âŒ í’ˆì§ˆ ê¸°ì¤€ ì‹¤íŒ¨ ë˜ëŠ” ë¹Œë“œ ì˜¤ë¥˜"
        }
    }
}

