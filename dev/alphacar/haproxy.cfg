global
    log stdout format raw local0
    maxconn 2000
    daemon

defaults
    log     global
    mode    http
    option  httplog
    timeout connect 5000
    timeout client  50000
    timeout server  50000
    option forwardfor

frontend api_gateway_internal
    bind *:9090
    mode http

    # 규칙 정의
    acl is_ai_chat path_beg /api/chat
    acl is_main_api path_beg /api/main
    acl is_vehicle_detail_api path_beg /api/vehicles/detail
    acl is_vehicle_api path_beg /api/vehicles
    acl is_estimate_api path_beg /api/estimate
    acl is_quote_api path_beg /api/quote
    acl is_news_api path_beg /api/news
    acl is_community_api path_beg /api/community
    acl is_mypage_api path_beg /api/mypage
    acl is_search_api path_beg /api/search
    acl is_auth_api path_beg /auth
    acl is_recent_views path_beg /api/recent-views
    acl is_history_api path_beg /api/history

    # 연결 (더 구체적인 경로를 먼저 체크)
    use_backend ai_backend if is_ai_chat
    use_backend main_backend if is_vehicle_detail_api
    use_backend main_backend if is_main_api
    use_backend main_backend if is_history_api
    use_backend main_backend if is_recent_views
    use_backend quote_backend if is_vehicle_api
    use_backend quote_backend if is_estimate_api
    use_backend quote_backend if is_quote_api
    use_backend news_backend if is_news_api
    use_backend community_backend if is_community_api
    use_backend mypage_backend if is_mypage_api
    use_backend search_backend if is_search_api
    use_backend mypage_backend if is_auth_api

    default_backend main_backend

# 백엔드 서버 그룹
backend main_backend
    mode http
    http-request replace-path /api/(.*) /\1
    server main_server alphacar-main:3002 check

backend quote_backend
    mode http
    server quote_server alphacar-quote:3003 check

backend news_backend
    mode http
    http-request replace-path /api/(.*) /\1
    server news_server alphacar-drive:3004 check

backend community_backend
    mode http
    http-request replace-path /api/(.*) /\1
    server community_server alphacar-community:3005 check

backend mypage_backend
    mode http
    http-request replace-path /api/(.*) /\1
    server mypage_server alphacar-mypage:3006 check

backend search_backend
    mode http
    http-request replace-path /api/(.*) /\1
    server search_server alphacar-search:3007 check

backend ai_backend
    mode http
    http-request replace-path /api/chat/(.*) /chat/\1
    server ai_server alphacar-aichat:3008 check
