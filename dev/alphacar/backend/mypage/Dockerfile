# --- 1ë‹¨ê³„: ë¹Œë“œ ìŠ¤í…Œì´ì§€ ---
FROM node:20-alpine AS builder

RUN apk add --no-cache libc6-compat
WORKDIR /app

# 1. ë£¨íŠ¸ ì˜ì¡´ì„± ì„¤ì¹˜
COPY package*.json ./
RUN npm install -g @nestjs/cli && \
    npm install --legacy-peer-deps

# 2. mypage ì˜ì¡´ì„± ì„¤ì¹˜ (ì¤‘ìš”!)
# mypage í´ë”ì˜ package.jsonì„ ë³µì‚¬í•´ì„œ ì„¤ì¹˜í•©ë‹ˆë‹¤.
COPY mypage/package.json ./mypage/
RUN cd mypage && npm install --legacy-peer-deps

# 3. ì†ŒìŠ¤ ì½”ë“œ ë³µì‚¬
COPY . .

# 4. ë¹Œë“œ ì‹¤í–‰
# --verbose ì œê±° ë° mypage í´ë”ì—ì„œ ë¹Œë“œ
RUN cd mypage && \
    echo "ğŸš€ Starting nest build for mypage..." && \
    NODE_OPTIONS="--max-old-space-size=4096" nest build

# --- 2ë‹¨ê³„: ì‹¤í–‰ ìŠ¤í…Œì´ì§€ ---
FROM node:20-alpine
WORKDIR /app

RUN apk add --no-cache libc6-compat

# 5. ê²°ê³¼ë¬¼ ë³µì‚¬
# mypageì˜ ê²°ê³¼ë¬¼ì„ ê°€ì ¸ì˜µë‹ˆë‹¤.
COPY --from=builder /app/mypage/dist ./dist
COPY --from=builder /app/mypage/node_modules ./node_modules
COPY --from=builder /app/mypage/package.json ./package.json

EXPOSE 3000

CMD ["node", "dist/main"]
