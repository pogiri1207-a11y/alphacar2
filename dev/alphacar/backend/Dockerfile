# ---------------------------------------------------
# 1. ë¹Œë“œ ë‹¨ê³„ (Builder) - ëª¨ë“  ë„êµ¬ í¬í•¨
# ---------------------------------------------------
FROM node:20-alpine AS builder
ARG APP_NAME

WORKDIR /app

# 1-1. ì•ŒíŒŒì¸ ë¦¬ëˆ…ìŠ¤ í•„ìˆ˜ íŒ¨í‚¤ì§€ (NestJS/Node í˜¸í™˜ì„±)
RUN apk add --no-cache libc6-compat

# 1-2. íŒ¨í‚¤ì§€ íŒŒì¼ ë³µì‚¬
# (ë¹Œë“œ ì»¨í…ìŠ¤íŠ¸ê°€ backend/ ì´ë¯€ë¡œ í•´ë‹¹ ê²½ë¡œ ê¸°ì¤€)
COPY package.json package-lock.json ./
COPY ${APP_NAME}/package.json ${APP_NAME}/

# 1-3. ì˜ì¡´ì„± ì„¤ì¹˜ (CI ëª¨ë“œ: ë¹ ë¥´ê³  ì •í™•í•¨)
# ì´ë•ŒëŠ” ë¹Œë“œë¥¼ ìœ„í•´ devDependencies(NestCLI ë“±)ê°€ ëª¨ë‘ ì„¤ì¹˜ë©ë‹ˆë‹¤.
RUN npm install -g @nestjs/cli
RUN npm install --legacy-peer-deps

# 1-4. ì†ŒìŠ¤ ì½”ë“œ ë³µì‚¬ ë° ë¹Œë“œ
COPY . .
# ìŠ¤í‚¤ë§ˆ ë³µì‚¬ (í•„ìš”í•œ ê²½ìš°)
RUN [ -d "schemas" ] && cp -r schemas ${APP_NAME}/src/ || true
# ë¹Œë“œ ì‹¤í–‰ -> dist í´ë” ìƒì„±
RUN cd ${APP_NAME} && nest build

# ğŸ”¥ [ë‹¤ì´ì–´íŠ¸ í•µì‹¬] ë¹Œë“œ ì™„ë£Œ í›„, ì‹¤í–‰ì— í•„ìš” ì—†ëŠ” 'ê°œë°œìš© íŒ¨í‚¤ì§€' ì œê±°
# ì´ ëª…ë ¹ì–´ê°€ ì‹¤í–‰ë˜ë©´ node_modules í¬ê¸°ê°€ í™• ì¤„ì–´ë“­ë‹ˆë‹¤.
RUN npm prune --production
RUN cd ${APP_NAME} && npm prune --production

# ---------------------------------------------------
# 2. ì‹¤í–‰ ë‹¨ê³„ (Runner) - ì´ˆê²½ëŸ‰í™”
# ---------------------------------------------------
FROM node:20-alpine AS runner
ARG APP_NAME

WORKDIR /app
ENV NODE_ENV=production

# 2-1. [ì ˆëŒ€ ê¸ˆì§€] RUN npm install ëª…ë ¹ì–´ ê¸ˆì§€! âŒ
# ëŒ€ì‹  Builderì—ì„œ ì´ë¯¸ ì •ë¦¬ëœ node_modulesë¥¼ ë³µì‚¬í•´ì˜µë‹ˆë‹¤. âœ…
COPY --from=builder /app/node_modules ./node_modules
# ì•± ë‚´ë¶€ì— ë³„ë„ node_modulesê°€ ìƒì„±ëœ ê²½ìš°ë¥¼ ëŒ€ë¹„í•´ ë³µì‚¬ (ì—†ìœ¼ë©´ ë¬´ì‹œë¨)
COPY --from=builder /app/${APP_NAME}/node_modules ./${APP_NAME}/node_modules

# 2-2. ì‹¤í–‰ íŒŒì¼(dist)ê³¼ ì„¤ì • íŒŒì¼(package.json) í•œ ë²ˆì— ë³µì‚¬
# ë ˆì´ì–´ë¥¼ ì¤„ì´ê¸° ìœ„í•´ í•œ ì¤„ë¡œ ì²˜ë¦¬
COPY --from=builder /app/${APP_NAME}/dist /app/${APP_NAME}/package.json ./

# 2-3. ì‹¤í–‰
EXPOSE 3000-4000
CMD ["sh", "-c", "node $(find . -name main.js | head -n 1)"]
