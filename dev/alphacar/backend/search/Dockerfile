# --- 1ë‹¨ê³„: ë¹Œë“œ ìŠ¤í…Œì´ì§€ ---
FROM node:20-alpine AS builder

RUN apk add --no-cache libc6-compat
WORKDIR /app

# 1. ë£¨íŠ¸ ì˜ì¡´ì„± ì„¤ì¹˜
COPY package*.json ./
RUN npm install -g @nestjs/cli && \
    npm install --legacy-peer-deps

# 2. search ì˜ì¡´ì„± ì„¤ì¹˜ (ì¤‘ìš”!)
# search í´ë”ì˜ package.jsonì„ ë³µì‚¬í•´ì„œ ì„¤ì¹˜í•©ë‹ˆë‹¤.
COPY search/package.json ./search/
RUN cd search && npm install --legacy-peer-deps

# 3. ì†ŒìŠ¤ ì½”ë“œ ë³µì‚¬
COPY . .

# 4. ë¹Œë“œ ì‹¤í–‰
# --verbose ì‚­ì œ ë° search í´ë”ì—ì„œ ë¹Œë“œ ìˆ˜í–‰
RUN cd search && \
    echo "ğŸš€ Starting nest build for search..." && \
    NODE_OPTIONS="--max-old-space-size=4096" nest build

# --- 2ë‹¨ê³„: ì‹¤í–‰ ìŠ¤í…Œì´ì§€ ---
FROM node:20-alpine
WORKDIR /app

RUN apk add --no-cache libc6-compat

# 5. ê²°ê³¼ë¬¼ ë³µì‚¬
# searchì˜ ê²°ê³¼ë¬¼ì„ ê°€ì ¸ì˜µë‹ˆë‹¤.
COPY --from=builder /app/search/dist ./dist
COPY --from=builder /app/search/node_modules ./node_modules
COPY --from=builder /app/search/package.json ./package.json

EXPOSE 3000

CMD ["node", "dist/main"]
