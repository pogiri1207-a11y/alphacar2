pipeline {
    agent any

    parameters {
        // ë¹Œë“œí•  ì„œë¹„ìŠ¤ë¥¼ ì„ íƒ (ì „ì²´ ë¹Œë“œë„ ê°€ëŠ¥í•˜ê²Œ 'all' ì¶”ê°€)
        choice(name: 'SERVICE_NAME', 
               choices: ['all', 'main', 'aichat', 'news', 'mypage', 'community', 'search', 'quote'], 
               description: 'ë¹Œë“œí•  ë°±ì—”ë“œ ì„œë¹„ìŠ¤ë¥¼ ì„ íƒí•˜ì„¸ìš”')
        string(name: 'VERSION', defaultValue: '1.0', description: 'ê¸°ë³¸ ë²„ì „ (ë’¤ì— ë¹Œë“œ ë²ˆí˜¸ê°€ ìë™ìœ¼ë¡œ ë¶™ìŠµë‹ˆë‹¤)')
    }

    environment {
        HARBOR_URL = 'http://192.168.56.200:30002'
        HARBOR_PROJECT = 'alphacar'
        CREDENTIAL_ID = 'harbor-cred' // ì  í‚¨ìŠ¤ì— ë“±ë¡í•œ Harbor ID/PW
        SONARQUBE = 'sonarqube'
        SONAR_URL = 'http://192.168.56.200:32001'
        SONAR_TOKEN_ID = 'sonarqube-token' // SonarQube í† í° (ì—†ìœ¼ë©´ ë¹ˆ ë¬¸ìì—´ë¡œ ì„¤ì •)
    }

    stages {
        stage('Prepare') {
            steps {
                script {
                    // ë²„ì „ ë²ˆí˜¸ ìƒì„± (ì˜ˆ: 1.0.25)
                    env.FULL_VERSION = "${params.VERSION}.${currentBuild.number}"
                    
                    // ë¹Œë“œí•  ì„œë¹„ìŠ¤ ëª©ë¡ ê²°ì •
                    if (params.SERVICE_NAME == 'all') {
                        env.SERVICES = 'main,aichat,news,mypage,community,search,quote'
                    } else {
                        env.SERVICES = params.SERVICE_NAME
                    }
                    echo "ğŸš€ Target Services: ${env.SERVICES} / Version: ${env.FULL_VERSION}"
                }
            }
        }

        stage('SonarQube Analysis') {
            steps {
                script {
                    // SonarQube ì—°ê²° í™•ì¸ ë° ì„ íƒì  ì‹¤í–‰
                    def sonarAvailable = false
                    try {
                        def response = sh(
                            script: "curl -s -m 5 ${SONAR_URL}/api/system/status || echo 'FAILED'",
                            returnStdout: true
                        ).trim()
                        if (response.contains('"status"') || response.contains('UP')) {
                            sonarAvailable = true
                            echo "âœ… SonarQube ì„œë²„ ì—°ê²° í™•ì¸ë¨"
                        }
                    } catch (Exception e) {
                        echo "âš ï¸ SonarQube ì„œë²„ ì—°ê²° ì‹¤íŒ¨: ${e.getMessage()}"
                    }
                    
                    if (sonarAvailable) {
                        def scannerHome = tool 'sonar-scanner'
                        
                        // SonarQube ì¸ì¦ í† í° ì‚¬ìš© (ì˜¤ë¥˜ ë¬´ì‹œí•˜ê³  ê³„ì† ì§„í–‰)
                        try {
                            withSonarQubeEnv("${SONARQUBE}") {
                                def output = sh(
                                    script: """
                                        ${scannerHome}/bin/sonar-scanner \\
                                            -Dsonar.projectKey=alphacar-backend \\
                                            -Dsonar.projectName=alphacar-backend \\
                                            -Dsonar.sources=backend \\
                                            -Dsonar.host.url=${SONAR_URL} \\
                                            -Dsonar.sourceEncoding=UTF-8 \\
                                            -Dsonar.scanner.timeout=300 2>&1
                                    """,
                                    returnStdout: true
                                )
                                if (output.contains("ANALYSIS SUCCESSFUL")) {
                                    echo "âœ… SonarQube ë¶„ì„ ì™„ë£Œ"
                                } else {
                                    echo "âš ï¸ SonarQube ë¶„ì„ ì™„ë£Œ (ì¼ë¶€ ê²½ê³  ë°œìƒ, ê³„ì† ì§„í–‰)"
                                }
                            }
                        } catch (Exception e) {
                            // withSonarQubeEnv ì‹¤íŒ¨ ì‹œ í† í° ì§ì ‘ ì‚¬ìš© ì‹œë„
                            echo "âš ï¸ withSonarQubeEnv ì‹¤íŒ¨, í† í° ì§ì ‘ ì‚¬ìš© ì‹œë„..."
                            try {
                                withCredentials([string(credentialsId: "${SONAR_TOKEN_ID}", variable: 'SONAR_TOKEN')]) {
                                    def output = sh(
                                        script: """
                                            ${scannerHome}/bin/sonar-scanner \\
                                                -Dsonar.projectKey=alphacar-backend \\
                                                -Dsonar.projectName=alphacar-backend \\
                                                -Dsonar.sources=backend \\
                                                -Dsonar.host.url=${SONAR_URL} \\
                                                -Dsonar.token=\${SONAR_TOKEN} \\
                                                -Dsonar.sourceEncoding=UTF-8 \\
                                                -Dsonar.scanner.timeout=300 2>&1
                                        """,
                                        returnStdout: true
                                    )
                                    if (output.contains("ANALYSIS SUCCESSFUL")) {
                                        echo "âœ… SonarQube ë¶„ì„ ì™„ë£Œ (í† í° ì‚¬ìš©)"
                                    } else {
                                        echo "âš ï¸ SonarQube ë¶„ì„ ì™„ë£Œ (ì¼ë¶€ ê²½ê³  ë°œìƒ, ê³„ì† ì§„í–‰)"
                                    }
                                }
                            } catch (Exception e2) {
                                echo "âš ï¸ SonarQube ë¶„ì„ ì‹¤íŒ¨, ê³„ì† ì§„í–‰: ${e2.getMessage()}"
                            }
                        }
                    } else {
                        echo "âš ï¸ SonarQube ì„œë²„ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë¶„ì„ì„ ê±´ë„ˆëœë‹ˆë‹¤."
                    }
                    echo "âœ… SonarQube ë‹¨ê³„ ì™„ë£Œ - Trivyë¡œ ì§„í–‰"
                }
            }
        }

        stage('Trivy Security Scan') {
            steps {
                script {
                    // Trivy DB ì—…ë°ì´íŠ¸
                    echo "ğŸ”„ Updating Trivy DB..."
                    sh "docker run --rm -v trivy_cache:/root/.cache aquasec/trivy:latest image --download-db-only || true"
                    
                    def serviceList = env.SERVICES.split(',')
                    def TRIVY_OPTIONS = "--exit-code 0 --severity HIGH,CRITICAL --timeout 5m --no-progress --skip-db-update --skip-files 'root/.npm/_cacache/*' --cache-dir /root/.cache/trivy"
                    
                    // ì†ŒìŠ¤ ì½”ë“œ ìŠ¤ìº” (ë¹Œë“œ ì „)
                    def scanSteps = [:]
                    serviceList.each { service ->
                        scanSteps["Scan-${service}"] = {
                            echo "ğŸ›¡ï¸ Scanning [${service}] source code..."
                            sh """
                                docker run --rm \\
                                    -v \$(pwd):/workspace \\
                                    -v trivy_cache:/root/.cache \\
                                    -w /workspace \\
                                    aquasec/trivy:latest fs ${TRIVY_OPTIONS} \\
                                    backend/${service}/ 2>&1 || true
                            """
                        }
                    }
                    
                    // ë³‘ë ¬ ìŠ¤ìº” ì‹¤í–‰
                    parallel scanSteps
                    echo "âœ… Trivy ë³´ì•ˆ ìŠ¤ìº” ì™„ë£Œ - ë¹Œë“œë¡œ ì§„í–‰"
                }
            }
        }

        stage('Docker Build & Push') {
            steps {
                script {
                        withCredentials([usernamePassword(credentialsId: "${CREDENTIAL_ID}", usernameVariable: 'HUB_USER', passwordVariable: 'HUB_PASS')]) {
                        // Harbor ë¡œê·¸ì¸ (HTTP ì‚¬ìš©)
                        // ì£¼ì˜: í˜¸ìŠ¤íŠ¸ ë…¸ë“œì˜ Docker daemonì´ insecure registryë¥¼ ì¸ì‹í•˜ë ¤ë©´ ì¬ì‹œì‘ í•„ìš”
                        sh """
                            # Harbor ë¡œê·¸ì¸ (í”„ë¡œí† ì½œ ì—†ì´ ì‹œë„ - Docker daemonì´ insecure registryë¡œ ì¸ì‹)
                            echo "\${HUB_PASS}" | docker login 192.168.56.200:30002 -u \${HUB_USER} --password-stdin
                        """

                        def serviceList = env.SERVICES.split(',')
                        
                        // ë³‘ë ¬ ë¹Œë“œ (ë¹ ë¥¸ ë¹Œë“œ)
                        def buildSteps = [:]
                        serviceList.each { service ->
                            buildSteps["Build-${service}"] = {
                                echo "ğŸ“¦ Building [${service}]..."
                                def imageBase = "192.168.56.200:30002/${HARBOR_PROJECT}/${service}"
                                timeout(time: 20, unit: 'MINUTES') {
                                    sh """
                                        # BuildKit í™œì„±í™” ë° ìºì‹œ ì´ë¯¸ì§€ pull
                                        export DOCKER_BUILDKIT=1
                                        docker pull ${imageBase}:latest || true
                                        
                                        # ë¹Œë“œ ì»¨í…ìŠ¤íŠ¸ í™•ì¸
                                        echo "ğŸ“ Build context: backend/"
                                        echo "ğŸ“„ Dockerfile: backend/${service}/Dockerfile"
                                        
                                        # BuildKitì„ ì‚¬ìš©í•œ ë¹ ë¥¸ ë¹Œë“œ (ìƒì„¸ ë¡œê·¸)
                                        docker build \\
                                            --build-arg APP_NAME=${service} \\
                                            --cache-from ${imageBase}:latest \\
                                            --progress=plain \\
                                            --no-cache=false \\
                                            -f backend/${service}/Dockerfile \\
                                            -t ${imageBase}:${env.FULL_VERSION} \\
                                            -t ${imageBase}:latest \\
                                            backend/ 2>&1 | tee /tmp/build-${service}.log || {
                                            echo "âš ï¸ Build failed, checking logs..."
                                            tail -50 /tmp/build-${service}.log || true
                                            echo "âš ï¸ Retrying without cache..."
                                            docker build \\
                                                --build-arg APP_NAME=${service} \\
                                                --progress=plain \\
                                                -f backend/${service}/Dockerfile \\
                                                -t ${imageBase}:${env.FULL_VERSION} \\
                                                -t ${imageBase}:latest \\
                                                backend/
                                        }
                                        
                                        # ë¹Œë“œëœ ì´ë¯¸ì§€ í™•ì¸ ë° ê²€ì¦
                                        echo "ğŸ” Verifying built image..."
                                        if docker images --format '{{.Repository}}:{{.Tag}}' | grep -q "^${imageBase}:${env.FULL_VERSION}\$"; then
                                            echo "âœ… Image ${imageBase}:${env.FULL_VERSION} built successfully"
                                            docker images | grep ${service} | head -3
                                        else
                                            echo "âŒ Image ${imageBase}:${env.FULL_VERSION} not found after build!"
                                            echo "ğŸ“‹ Available images:"
                                            docker images | grep ${service} || echo "No images found"
                                            exit 1
                                        fi
                                    """
                                }
                            }
                        }
                        
                        // ë³‘ë ¬ ë¹Œë“œ ì‹¤í–‰
                        parallel buildSteps
                        echo "âœ… All images built successfully"
                        
                        // ë¹Œë“œ ê²€ì¦: ëª¨ë“  ì´ë¯¸ì§€ê°€ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸
                        echo "ğŸ” Verifying all built images..."
                        serviceList.each { service ->
                            def imageBase = "192.168.56.200:30002/${HARBOR_PROJECT}/${service}"
                            sh """
                                if ! docker images --format '{{.Repository}}:{{.Tag}}' | grep -q "^${imageBase}:${env.FULL_VERSION}\$"; then
                                    echo "âŒ ERROR: Image ${imageBase}:${env.FULL_VERSION} not found!"
                                    exit 1
                                fi
                            """
                        }
                        echo "âœ… All images verified"
                        
                        // ë³‘ë ¬ í‘¸ì‹œ (íƒ€ì„ì•„ì›ƒ ì„¤ì •)
                        def pushSteps = [:]
                        serviceList.each { service ->
                            pushSteps["Push-${service}"] = {
                                timeout(time: 10, unit: 'MINUTES') {
                                    echo "ğŸ“¤ Pushing [${service}]..."
                                    def imageBase = "192.168.56.200:30002/${HARBOR_PROJECT}/${service}"
                                    
                                    // ì´ë¯¸ì§€ ì¡´ì¬ ì—¬ë¶€ í™•ì¸
                                    sh """
                                        echo "ğŸ” Checking if image exists..."
                                        if docker images --format '{{.Repository}}:{{.Tag}}' | grep -q "^${imageBase}:${env.FULL_VERSION}\$"; then
                                            echo "âœ… Image ${imageBase}:${env.FULL_VERSION} found"
                                        else
                                            echo "âŒ Image ${imageBase}:${env.FULL_VERSION} not found!"
                                            echo "ğŸ“‹ Available images:"
                                            docker images | grep ${service} || echo "No images found for ${service}"
                                            exit 1
                                        fi
                                    """
                                    
                                    retry(3) {
                                        sh """
                                            # ë²„ì „ íƒœê·¸ í‘¸ì‹œ
                                            echo "ğŸ“¤ Pushing ${imageBase}:${env.FULL_VERSION}..."
                                            docker push ${imageBase}:${env.FULL_VERSION} || {
                                                echo "âš ï¸ Push failed, retrying..."
                                                sleep 2
                                                docker push ${imageBase}:${env.FULL_VERSION} || exit 1
                                            }
                                            
                                            # latest íƒœê·¸ í‘¸ì‹œ
                                            echo "ğŸ“¤ Pushing ${imageBase}:latest..."
                                            docker push ${imageBase}:latest || {
                                                echo "âš ï¸ Push latest failed, retrying..."
                                                sleep 2
                                                docker push ${imageBase}:latest || exit 1
                                            }
                                            
                                            echo "âœ… Successfully pushed ${service} to Harbor"
                                            
                                            # ì´ë¯¸ì§€ ì‚­ì œ (ì„ íƒì )
                                            docker rmi ${imageBase}:${env.FULL_VERSION} || true
                                        """
                                    }
                                }
                            }
                        }
                        
                        // ë³‘ë ¬ í‘¸ì‹œ ì‹¤í–‰
                        parallel pushSteps
                        echo "âœ… All images pushed to Harbor"
                        
                        sh "docker logout 192.168.56.200:30002"
                    }
                }
            }
        }
    }

    post {
        success { echo "âœ… ë°±ì—”ë“œ ë°°í¬ ì¤€ë¹„ ì™„ë£Œ! í•˜ë²„ë¥¼ í™•ì¸í•˜ì„¸ìš”." }
        failure { echo "âŒ ë¹Œë“œ ì‹¤íŒ¨! ë¡œê·¸ë¥¼ í™•ì¸í•´ ì£¼ì„¸ìš”." }
    }
}
