pipeline {
    agent any

    environment {
        HARBOR_URL = '192.168.0.169'
        HARBOR_PROJECT = 'alphacar-project'
        ROLLBACK_VERSION = '1.0.0.85'
    }

    stages {
        stage('Rollback to Build #85') {
            steps {
                sshagent(credentials: ['ssh-server']) {
                    withCredentials([file(credentialsId: 'ALPHACAR', variable: 'ENV_FILE_PATH'),
                                     usernamePassword(credentialsId: 'harbor-cred', usernameVariable: 'HB_USER', passwordVariable: 'HB_PASS')]) {
                        script {
                            def remoteIP = '192.168.0.160'
                            def remoteUser = 'kevin'

                            try {
                                def envContent = readFile(ENV_FILE_PATH).trim()

                                sh """
                                set -e
                                echo "ğŸ”„ ë¡¤ë°± ì‹œì‘: ë¹Œë“œ #85 (ë²„ì „ ${ROLLBACK_VERSION})"
                                
                                ssh -o StrictHostKeyChecking=no -o ConnectTimeout=10 ${remoteUser}@${remoteIP} bash -s <<ENDSSH
                                set -e
                                cd ~/alphacar/deploy
                                
                                echo "ğŸ“ í˜„ì¬ ë²„ì „ í™•ì¸..."
                                if [ -f .env ]; then
                                    echo "í˜„ì¬ BACKEND_VERSION: \$(grep BACKEND_VERSION .env || echo "ì—†ìŒ")"
                                    echo "í˜„ì¬ FRONTEND_VERSION: \$(grep FRONTEND_VERSION .env || echo "ì—†ìŒ")"
                                else
                                    echo "âŒ .env íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤"
                                    exit 1
                                fi
                                
                                echo "ğŸ“ .env íŒŒì¼ ë°±ì—…..."
                                cp .env .env.backup.\$(date +%Y%m%d_%H%M%S) 2>/dev/null || true
                                
                                echo "ğŸ“ ë²„ì „ ì—…ë°ì´íŠ¸..."
                                sed -i '/^BACKEND_VERSION=/d' .env
                                sed -i '/^FRONTEND_VERSION=/d' .env
                                echo "BACKEND_VERSION=${ROLLBACK_VERSION}" >> .env
                                echo "FRONTEND_VERSION=${ROLLBACK_VERSION}" >> .env
                                echo "âœ… ë²„ì „ì´ ${ROLLBACK_VERSION}ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤"
                                
                                echo "ğŸ” Harbor ë¡œê·¸ì¸..."
                                echo '${HB_PASS}' | docker login ${HARBOR_URL} -u '${HB_USER}' --password-stdin || {
                                    echo "âŒ Harbor ë¡œê·¸ì¸ ì‹¤íŒ¨"
                                    exit 1
                                }
                                echo "âœ… Harbor ë¡œê·¸ì¸ ì„±ê³µ"
                                
                                echo "ğŸ“¥ ì´ë¯¸ì§€ Pull..."
                                if [ ! -f docker-compose.yml ]; then
                                    echo "âŒ docker-compose.yml not found"
                                    exit 1
                                fi
                                
                                docker compose pull || {
                                    echo "âš ï¸ ì¼ë¶€ ì´ë¯¸ì§€ pull ì‹¤íŒ¨ (ê³„ì† ì§„í–‰)"
                                }
                                echo "âœ… ì´ë¯¸ì§€ pull ì™„ë£Œ"
                                
                                echo "ğŸš€ ì„œë¹„ìŠ¤ ì¬ì‹œì‘..."
                                docker compose up -d --force-recreate || {
                                    echo "âŒ ì„œë¹„ìŠ¤ ì¬ì‹œì‘ ì‹¤íŒ¨"
                                    docker compose ps
                                    exit 1
                                }
                                echo "âœ… ì„œë¹„ìŠ¤ ì¬ì‹œì‘ ì™„ë£Œ"
                                
                                echo "ğŸ“Š ì„œë¹„ìŠ¤ ìƒíƒœ:"
                                docker compose ps
                                
                                echo "âœ… ë¡¤ë°± ì™„ë£Œ: ë¹Œë“œ #85 (ë²„ì „ ${ROLLBACK_VERSION})"
ENDSSH
                                echo "âœ… ë¡¤ë°± ì™„ë£Œ"
                                """
                            } catch (Exception e) {
                                echo "âŒ ë¡¤ë°± ì‹¤íŒ¨: ${e.getMessage()}"
                                error("ë¡¤ë°± ì‹¤íŒ¨: ${e.getMessage()}")
                            }
                        }
                    }
                }
            }
        }
    }

    post {
        success {
            echo "âœ… ë¡¤ë°±ì´ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ‰"
        }
        failure {
            echo "âŒ ë¡¤ë°± ì‹¤íŒ¨! ë¡œê·¸ë¥¼ í™•ì¸í•˜ì„¸ìš”."
        }
    }
}



